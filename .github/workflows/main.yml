name: Build_iOS_Windows_Final
on: [workflow_dispatch]
jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - name: Force Fix and Prepare
        run: |
          # 1. 強制生成所有 iOS 必要的「咚咚」(Info.plist 等)
          flutter create --platforms ios .
          
          # 2. 自動注入權限
          find ios/Runner -name "Info.plist" -exec sed -i '' '/<dict>/a \
          <key>NSBrightnessUsageDescription</key><string>壓力測試需要</string>\
          <key>UIFileSharingEnabled</key><true/>\
          <key>LSSupportsOpeningDocumentsInPlace</key><true/>' {} +
          
          # 3. 下載套件
          flutter pub get

      - name: Package Raw Source
        run: |
          # 4. 直接把整包專案壓縮，因為 Sideloadly 有時候可以直接跑原始碼
          zip -r project_source.zip . -x "**.git**" "**.dart_tool**" "**build**"
          
      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: ios-ready-source
          path: project_source.zip
